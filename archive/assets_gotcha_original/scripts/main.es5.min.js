// =============================================================================
// Global functions
// =============================================================================

"use strict";

// Check ready state

function ready(fn) {
  if (
    document.attachEvent
      ? document.readyState === "complete"
      : document.readyState !== "loading"
  ) {
    fn();
  } else {
    document.addEventListener("DOMContentLoaded", fn);
  }
}

function polyfills() {
  // Matches()
  if (!Element.prototype.matches) {
    Element.prototype.matches =
      Element.prototype.matchesSelector ||
      Element.prototype.mozMatchesSelector ||
      Element.prototype.msMatchesSelector ||
      Element.prototype.oMatchesSelector ||
      Element.prototype.webkitMatchesSelector ||
      function(s) {
        var matches = (this.document || this.ownerDocument).querySelectorAll(s),
          i = matches.length;
        while (--i >= 0 && matches.item(i) !== this) {}
        return i > -1;
      };
  }
  // Closest()
  if (!Element.prototype.closest) {
    Element.prototype.closest = function(s) {
      var el = this;
      if (!document.documentElement.contains(el)) return null;
      do {
        if (el.matches(s)) return el;
        el = el.parentElement || el.parentNode;
      } while (el !== null && el.nodeType === 1);
      return null;
    };
  }
}

// ==========================================================================
// Initialize
// ==========================================================================

console.log("File loaded.");

function initialize() {
  console.log("JavaScript loaded and initialized.");
  polyfills();
  moment().format();

  // Mobile side navigation
  var sidenavigation = document.getElementById("sidenavigation");
  var sidenavigationBtn = document.getElementById("sidenavigationBtn");

  // Input clear element
  var inputClearElement = document.createElement("span");
  inputClearElement.className = "btn--input-clear";

  // Address inputs
  var craneAtRetrieval = document.getElementById("craneAtRetrieval");
  var customerDeliversOrder = document.getElementById("customerDeliversOrder");
  var retrievalAddress = document.getElementById("retrievalAddress");
  var craneAtDelivery = document.getElementById("craneAtDelivery");
  var customerRetrievesOrder = document.getElementById(
    "customerRetrievesOrder"
  );
  var deliveryAddress = document.getElementById("deliveryAddress");

  // Change event listeners
  document.addEventListener("change", function(event) {
    if (
      event.target.classList.contains("file-upload__image-upload") ||
      event.target.classList.contains("file-upload__sketch-upload")
    ) {
      var fileInput = event.target;
      var uploadContainer = event.target.closest(".file-upload--container");
      var file = null;
      if (fileInput.files.length !== 0) {
        file = fileInput.files[0];
        var imageThumbnail = fileInput.nextElementSibling.children[0];
        var imageReader = new FileReader();

        imageReader.onloadend = function() {
          return (imageThumbnail.src = imageReader.result);
        };

        if (file) {
          imageReader.readAsDataURL(file);
          imageThumbnail.parentElement.classList.add("js-has-thumbnail");
          uploadContainer.classList.add("js-has-file");
        }
      }
    }

    // Addresses checkboxes
    // Could be refactored into a function, but meh
    if (event.target === customerDeliversOrder) {
      if (customerDeliversOrder.checked) {
        craneAtRetrieval.checked = false;
        craneAtRetrieval.disabled = true;
        craneAtRetrieval.classList.add("js-disabled");
        retrievalAddress.selectedIndex = 0;
        retrievalAddress.disabled = true;
        retrievalAddress.classList.add("js-disabled");
      } else {
        craneAtRetrieval.disabled = false;
        craneAtRetrieval.classList.remove("js-disabled");
        retrievalAddress.disabled = false;
        retrievalAddress.classList.remove("js-disabled");
      }
    }
    if (event.target === craneAtRetrieval) {
      if (craneAtRetrieval.checked) {
        customerDeliversOrder.checked = false;
        customerDeliversOrder.disabled = true;
        customerDeliversOrder.classList.add("js-disabled");
      } else {
        customerDeliversOrder.disabled = false;
        customerDeliversOrder.classList.remove("js-disabled");
      }
    }
    if (event.target === customerRetrievesOrder) {
      if (customerRetrievesOrder.checked) {
        craneAtDelivery.checked = false;
        craneAtDelivery.disabled = true;
        craneAtDelivery.classList.add("js-disabled");
        deliveryAddress.selectedIndex = 0;
        deliveryAddress.disabled = true;
        deliveryAddress.classList.add("js-disabled");
      } else {
        craneAtDelivery.disabled = false;
        craneAtDelivery.classList.remove("js-disabled");
        deliveryAddress.disabled = false;
        deliveryAddress.classList.remove("js-disabled");
      }
    }
    if (event.target === craneAtDelivery) {
      if (craneAtDelivery.checked) {
        customerRetrievesOrder.checked = false;
        customerRetrievesOrder.disabled = true;
        customerRetrievesOrder.classList.add("js-disabled");
      } else {
        customerRetrievesOrder.disabled = false;
        customerRetrievesOrder.classList.remove("js-disabled");
      }
    }
  });

  // Click event listeners
  document.addEventListener("click", function(event) {
    // Accordion products
    if (event.target.classList.contains("accordion__link--delete")) {
      var accordion = event.target.closest(".accordion");
      accordion.parentNode.removeChild(accordion);
    }

    // Input clear button
    if (event.target.className === "btn--input-clear") {
      event.target.previousElementSibling.value = "";
    }

    // Mobile side navigation
    if (
      event.target.id === "sidenavigationBtn" ||
      event.target.closest("#sidenavigationBtn") !== null
    ) {
      sidenavigationBtn.classList.toggle("js-active");
      sidenavigation.classList.toggle("js-active");
    }

    // Accordion headers
    if (
      event.target.classList.contains("accordion__expand") ||
      event.target.closest(".accordion__expand") !== null
    ) {
      event.target.closest(".accordion").classList.toggle("js-active");
    }

    // File upload
    if (
      event.target.classList.contains("file-upload__thumbnail") ||
      event.target.classList.contains("file-upload__thumbnail--container")
    ) {
      var imageThumbnail = void 0;
      var uploadContainer = event.target.closest(".file-upload--container");
      event.target.classList.contains("file-upload__thumbnail")
        ? (imageThumbnail = event.target)
        : (imageThumbnail = event.target.children[0]);
      imageThumbnail.src =
        "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
      imageThumbnail.parentElement.classList.remove("js-has-thumbnail");
      imageThumbnail.parentElement.previousElementSibling.value = "";
      uploadContainer.classList.remove("js-has-file");
    }

    // Tab previous & next buttons
    if (event.target.classList.contains("btn--tab-navigation")) {
      // Previous
      if (event.target.classList.contains("btn--prev")) {
        var currentTabContainer = event.target.closest(".tab-container");
        var previousTabContainer = currentTabContainer.previousElementSibling;
        if (previousTabContainer !== undefined) {
          window.scroll(0, 0);
          currentTabContainer.classList.remove("js-active");
          previousTabContainer.classList.add("js-active");
          document
            .querySelector(".tab-navigation__item.js-active")
            .classList.remove("js-active");
          document
            .querySelector("[data-tab=" + previousTabContainer.id + "]")
            .classList.add("js-active");
        }
      }
      // Next
      if (event.target.classList.contains("btn--next")) {
        var currentTabContainer = event.target.closest(".tab-container");
        var nextTabContainer = currentTabContainer.nextElementSibling;
        if (nextTabContainer !== undefined) {
          window.scroll(0, 0);
          currentTabContainer.classList.remove("js-active");
          nextTabContainer.classList.add("js-active");
          document
            .querySelector(".tab-navigation__item.js-active")
            .classList.remove("js-active");
          document
            .querySelector("[data-tab=" + nextTabContainer.id + "]")
            .classList.add("js-active");
        }
      }
    }

    // Tab header navigation
    if (event.target.classList.contains("tab-navigation__item")) {
      var currentTab = document.querySelector(
        ".tab-navigation__item.js-active"
      );
      var currentTabContainer = document.getElementById(
        currentTab.getAttribute("data-tab")
      );
      var newTabContainer = document.getElementById(
        event.target.getAttribute("data-tab")
      );
      if (newTabContainer !== null && newTabContainer !== currentTabContainer) {
        window.scroll(0, 0);
        currentTab.classList.remove("js-active");
        currentTabContainer.classList.remove("js-active");
        event.target.classList.add("js-active");
        newTabContainer.classList.add("js-active");
      }
    }

    // Document list expand button
    if (
      event.target.classList.contains("document-list__link--expand") ||
      event.target.closest(".document-list__link--expand")
    ) {
      event.target
        .closest(".document-list__file--sub")
        .classList.toggle("js-active");
    }

    // Document sublist expand button
    if (
      event.target.classList.contains("document-list__link--sub-expand") ||
      event.target.closest(".document-list__link--sub-expand")
    ) {
      event.target
        .closest(".document-list__file--sub-list")
        .classList.toggle("js-active");
    }
  });

  // Input clear button
  document.addEventListener(
    "focus",
    function(event) {
      if (
        event.target.tagName === "INPUT" &&
        event.target.type === "text" &&
        event.target.readOnly === false
      ) {
        inputClearElement.style.opacity = "1";
        event.target.parentElement.appendChild(inputClearElement);
      }
      if (
        event.target.parentElement.classList.contains("product-list--container")
      ) {
        event.target.nextElementSibling.classList.add("js-active");
      }
    },
    true
  );

  document.addEventListener(
    "blur",
    function(event) {
      if (
        event.target.tagName === "INPUT" &&
        event.target.type === "text" &&
        event.target.readOnly === false
      ) {
        inputClearElement.style.opacity = "0";
      }
      if (
        event.target.parentElement.classList.contains("product-list--container")
      ) {
        event.target.nextElementSibling.classList.remove("js-active");
      }
    },
    true
  );

  // Oversættelse sker gennem dette objekt, default er engelsk
  var datePickeri18n = {
    previousMonth: "Forrige måned",
    nextMonth: "Næste måned",
    months: [
      "Januar",
      "Februar",
      "Marts",
      "April",
      "Maj",
      "Juni",
      "Juli",
      "August",
      "September",
      "Oktober",
      "November",
      "December"
    ],
    weekdays: [
      "Søndag",
      "Mandag",
      "Tirsdag",
      "Onsdag",
      "Torsdag",
      "Fredag",
      "Lørdag"
    ],
    weekdaysShort: ["S", "M", "T", "O", "T", "F", "S"]
  };

  // Opret følgeseddel - Afhentningsdato datepicker
  var deliveryNoteRetrievalDateDatePicker = new Pikaday({
    field: document.getElementById("retrievalDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("retrievalDate").appendChild(date);
    }
  });
  // Opret følgeseddel - Leveringssdato datepicker
  var deliveryNoteDeliveryDateDatePicker = new Pikaday({
    field: document.getElementById("deliveryDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("deliveryDate").appendChild(date);
    }
  });
  // Tilbud datepickers
  var offerFilterFromDatePicker = new Pikaday({
    field: document.getElementById("offerFilterFromDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("offerFilterFromDate").appendChild(date);
    },
    onClose: function onClose() {
      document.getElementById("offerFilterToDate").click();
    }
  });
  var offerFilterToDatePicker = new Pikaday({
    field: document.getElementById("offerFilterToDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("offerFilterToDate").appendChild(date);
    }
  });
  // Fakturaer datepickers
  var invoicesFilterFromDatePicker = new Pikaday({
    field: document.getElementById("invoicesFilterFromDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("invoicesFilterFromDate").appendChild(date);
    },
    onClose: function onClose() {
      document.getElementById("invoicesFilterToDate").click();
    }
  });
  var invoicesFilterToDatePicker = new Pikaday({
    field: document.getElementById("invoicesFilterToDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("invoicesFilterToDate").appendChild(date);
    }
  });
  // Kreditnotaer datepickers
  var creditFilterFromDatePicker = new Pikaday({
    field: document.getElementById("creditFilterFromDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("creditFilterFromDate").appendChild(date);
    },
    onClose: function onClose() {
      document.getElementById("creditFilterToDate").click();
    }
  });
  var creditFilterToDatePicker = new Pikaday({
    field: document.getElementById("creditFilterToDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("creditFilterToDate").appendChild(date);
    }
  });
  // Kontoudtog datepickers
  var withdrawalFilterFromDatePicker = new Pikaday({
    field: document.getElementById("withdrawalFilterFromDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("withdrawalFilterFromDate").appendChild(date);
    },
    onClose: function onClose() {
      document.getElementById("withdrawalFilterToDate").click();
    }
  });
  var withdrawalFilterToDatePicker = new Pikaday({
    field: document.getElementById("withdrawalFilterToDate"),
    i18n: datePickeri18n,
    format: "DD.MM.YYYY",
    firstDay: 1,
    position: "bottom left",
    maxDate: new Date(2020, 12, 31),
    yearRange: [1990, 2020],
    onSelect: function onSelect() {
      var date = document.createTextNode(
        this.getMoment().format("Do MMMM YYYY") + " "
      );
      document.getElementById("withdrawalFilterToDate").appendChild(date);
    }
  });

  // File upload thumbnail
  var fileUploadInputs = document.getElementsByClassName("file-upload__input");
  function fileUploadEventListener(input) {
    input.addEventListener("change", function(e) {
      var thumbnail = input.parentElement.querySelector(
        ".file-upload__thumbnail"
      );
      var file = input.files[0];
      var reader = new FileReader();

      reader.onloadend = function() {
        thumbnail.src = reader.result;
      };

      if (file) {
        reader.readAsDataURL(file);
      } else {
        thumbnail.src = "";
      }
    });
  }
  if (fileUploadInputs.length !== 0) {
    for (var i = 0; i < fileUploadInputs.length; ++i) {
      fileUploadEventListener(fileUploadInputs[i]);
    }
  }
}

ready(initialize);
